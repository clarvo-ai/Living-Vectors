name: Full Deployment to Cloud Run

on:
  push:
    branches:
      - test-sql-connection-2
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  BACKEND_SERVICE_NAME: lv-pyapi-dev
  BACKEND_REGISTRY: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/lv-registry
  BACKEND_IMAGE_NAME: lv-pyapi-dev
  FRONT_SERVICE_NAME: lv-web-dev
  FRONT_REGISTRY: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/lv-registry
  FRONT_IMAGE_NAME: lv-web-dev

jobs:
  backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate with GCP using GCP_SA_KEY
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          version: '>= 0.2.0'

      - name: Configure Docker to use gcloud as a credential helper
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Start Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.PGHOST }}=tcp:5432 &
          sleep 5

      - name: Install dependencies
        run: npm ci

      - name: URL-encode DB password
        run: |
          python - <<'PY'
          import urllib.parse, os
          encoded = urllib.parse.quote(os.environ["PGPASSWORD"], safe="")
          with open(os.environ["GITHUB_ENV"], "a") as fh:
              fh.write(f"PGPASSWORD_URLENCODED={encoded}\n")
          PY
        env:
          PGPASSWORD: ${{ secrets.PGPASSWORD }}

      - name: Run Prisma migrations
        env:
          DATABASE_URL: postgresql://${{ secrets.PGUSER }}:${{ env.PGPASSWORD_URLENCODED }}@127.0.0.1:5432/${{ secrets.PGDATABASE }}?schema=public
          DIRECT_DATABASE_URL: postgresql://${{ secrets.PGUSER }}:${{ env.PGPASSWORD_URLENCODED }}@127.0.0.1:5432/${{ secrets.PGDATABASE }}?schema=public
        run: npx turbo run db:migrate

      - name: Build and push backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/lv-pyapi/Dockerfile
          push: true
          tags: ${{ env.BACKEND_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy backend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE_NAME }}
          image: ${{ env.BACKEND_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
          region: ${{ env.REGION }}
          project_id: ${{ env.PROJECT_ID }}
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=1
            --min-instances=1
            --max-instances=5

  frontend:
    runs-on: ubuntu-latest
    needs: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate with GCP using GCP_SA_KEY
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          version: '>= 0.2.0'

      - name: Configure Docker to use gcloud as a credential helper
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/lv-web/Dockerfile
          push: true
          tags: ${{ env.FRONT_REGISTRY }}/${{ env.FRONT_IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy frontend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONT_SERVICE_NAME }}
          image: ${{ env.FRONT_REGISTRY }}/${{ env.FRONT_IMAGE_NAME }}:${{ github.sha }}
          region: ${{ env.REGION }}
          project_id: ${{ env.PROJECT_ID }}
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=1
            --min-instances=1
            --max-instances=5