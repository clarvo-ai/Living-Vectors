#name: Test Backend Deployment to Cloud Run
#
#on:
#  push:
#    branches:
#      - test-sql-connection-2
#  workflow_dispatch:
#
#env:
#  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
#  REGION: ${{ secrets.GCP_REGION }}
#  SERVICE_NAME: lv-pyapi-dev
#  REGISTRY: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/lv-registry
#  IMAGE_NAME: lv-pyapi-dev
#
#jobs:
#  deploy:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Authenticate with GCP using GCP_SA_KEY
#        uses: google-github-actions/auth@v2
#        with:
#          credentials_json: ${{ secrets.GCP_SA_KEY }}
#
#      - name: Set up Cloud SDK
#        uses: google-github-actions/setup-gcloud@v2
#        with:
#          project_id: ${{ env.PROJECT_ID }}
#          version: '>= 0.2.0'
#
#      - name: Configure Docker to use gcloud as a credential helper
#        run: |
#          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
#
#      - name: Start Cloud SQL Proxy
#        run: |
#          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
#          chmod +x cloud_sql_proxy
#          ./cloud_sql_proxy -instances=${{ secrets.PGHOST }}=tcp:5432 &
#          sleep 5
#
#      - name: Install dependencies
#        run: npm ci
#
#      - name: Run Prisma migrations
#        env:
#          DATABASE_URL: postgresql://${{ secrets.PGUSER }}:${{ secrets.PGPASSWORD }}@127.0.0.1:5432/${{ secrets.PGDATABASE }}?schema=public
#          DIRECT_DATABASE_URL: postgresql://${{ secrets.PGUSER }}:${{ secrets.PGPASSWORD }}@127.0.0.1:5432/${{ secrets.PGDATABASE }}?schema=public
#        run: npx turbo run db:migrate
#
#      - name: Build and push Docker image
#        uses: docker/build-push-action@v5
#        with:
#          context: .
#          file: ./apps/lv-pyapi/Dockerfile
#          push: true
#          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
#
#      - name: Deploy to Cloud Run
#        uses: google-github-actions/deploy-cloudrun@v2
#        with:
#          service: ${{ env.SERVICE_NAME }}
#          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
#          region: ${{ env.REGION }}
#          project_id: ${{ env.PROJECT_ID }}
#          flags: |
#            --allow-unauthenticated
#            --memory=1Gi
#            --cpu=1
#            --min-instances=1
#            --max-instances=5
