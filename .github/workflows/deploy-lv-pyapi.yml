name: Deploy lv-pyapi to Cloud Run

# When to run the workflow:
# - On push to main or dev branch on apps/lv-pyapi or packages/python-utils
# - On pull request to main branch on apps/lv-pyapi or packages/python-utils
# - Manually via workflow_dispatch
on:
  push:
    branches: [ main, dev ]
    paths:
      - 'apps/lv-pyapi/**'
      - 'packages/python-utils/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'apps/lv-pyapi/**'
      - 'packages/python-utils/**'
  workflow_dispatch:


# Environment variables:
env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  SERVICE_NAME: lv-pyapi-dev
  REGISTRY: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/lv-registry
  IMAGE_NAME: lv-pyapi-dev

# Jobs:
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      #Get the code
    - name: Checkout code
      uses: actions/checkout@v4

      #Login to Google Cloud
    - name: Authenticate with GCP using GCP_SA_KEY
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

      #Set up Cloud SDK
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        version: '>= 0.2.0'
      
      #Configure Docker
    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./apps/lv-pyapi/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      #Deploy the image to Cloud Run
    - name: Deploy the image to Cloud Run as lv-pyapi-dev
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: ${{ env.SERVICE_NAME }}
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        region: ${{ env.REGION }}
        project_id: ${{ env.PROJECT_ID }}
        flags: |
          --allow-unauthenticated
          --port=8080
          --memory=512Mi
          --cpu=1
          --max-instances=10

      #Show the URL
    - name: Show service URL
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format='value(status.url)')
        echo "Service deployed at: $SERVICE_URL"
