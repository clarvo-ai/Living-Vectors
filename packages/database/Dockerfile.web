FROM node:22-alpine AS base

ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD true

FROM base AS builder
RUN apk update
RUN apk add --no-cache libc6-compat \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    nodejs \
    yarn \
    # postgres client for init-db.sh
    postgresql-client


# Tell Puppeteer to skip installing Chrome. We'll be using the installed package.
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

WORKDIR /app

RUN npm install turbo --global

# Create a named build stage
WORKDIR /app
COPY . .

RUN turbo prune lv-web --docker

# Second stage - use the node image, not a non-existent 'base' image
FROM base AS installer
RUN apk update
RUN apk add --no-cache libc6-compat \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    nodejs \
    yarn \
    # postgres client for init-db.sh
    postgresql-client
WORKDIR /app

COPY --from=builder /app/out/json/ .
RUN npm install --frozen-lockfile
# First install the dependencies (as they change less often)

EXPOSE 3000